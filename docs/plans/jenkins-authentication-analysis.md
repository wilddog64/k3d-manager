# Jenkins Authentication Analysis

## Overview

This document analyzes Jenkins authentication behavior across all deployment scenarios and identifies gaps in the current implementation.

**Date**: 2025-11-04
**Status**: Analysis Complete - Implementation Plan Pending

---

## Current Implementation Analysis

### Scenario 1: `deploy_jenkins` (No Flags)

**Command**: `./scripts/k3d-manager deploy_jenkins`

**Expected Behavior**:
- Minimal deployment without Vault or LDAP integration
- Should use Jenkins built-in user database with local admin account
- Admin credentials should be accessible to operator

**Current Implementation**:
```bash
# jenkins.sh:864-866
if (( enable_vault )); then
   deploy_eso
fi

# jenkins.sh:869-874
if (( enable_vault )); then
   deploy_vault "$vault_namespace" "$vault_release"
else
   _info "[jenkins] skipping Vault deployment (using existing instance)"
fi

# jenkins.sh:882-884 - ALWAYS RUNS
_create_jenkins_admin_vault_policy "$vault_namespace" "$vault_release"
_create_jenkins_vault_ad_policy "$vault_namespace" "$vault_release" "$jenkins_namespace"
_create_jenkins_cert_rotator_policy "$vault_namespace" "$vault_release" "" "" "$jenkins_namespace"
```

**CRITICAL ISSUES**:

1. **Policy creation always runs** even when Vault is disabled (jenkins.sh:882-884)
   - Will fail with "vault pod not found" errors
   - Should be conditional on `enable_vault`

2. **Jenkins admin secret missing** (values.yaml:88-92)
   ```yaml
   admin:
     createSecret: false           # Helm won't create it
     existingSecret: jenkins-admin  # Expects pre-existing secret
     userKey: jenkins-admin-user
     passwordKey: jenkins-admin-password
   ```
   - Without Vault/ESO, the `jenkins-admin` secret won't exist
   - Pod will fail to start with "secret jenkins-admin not found"

3. **No fallback mechanism**
   - No code path to create local admin credentials
   - No static default password option
   - Helm chart expects secret to already exist

**Current Status**: ❌ **BROKEN** - Deployment will fail

---

### Scenario 2: `deploy_jenkins --enable-vault`

**Command**: `./scripts/k3d-manager deploy_jenkins --enable-vault`

**Expected Behavior**:
- Jenkins with Vault-issued TLS certificates
- Random admin password generated by Vault and synced via ESO
- No LDAP authentication

**Current Implementation**:

**Password Generation** (jenkins.sh:1364-1393):
```bash
function _create_jenkins_admin_vault_policy() {
   # Create password policy in Vault
   policy_content=$(cat <<'HCL'
length = 24
rule "charset" { charset = "abcdefghijklmnopqrstuvwxyz" }
rule "charset" { charset = "ABCDEFGHIJKLMNOPQRSTUVWXYZ" }
rule "charset" { charset = "0123456789" }
rule "charset" { charset = "!@#$%^&*()-_=+[]{};:,.?" }
HCL
)
   vault write sys/policies/password/jenkins-admin policy=-

   # Generate random password and store in Vault
   jenkins_admin_pass=$(vault read -field=password sys/policies/password/jenkins-admin/generate)
   vault kv put secret/eso/jenkins-admin username=jenkins-admin password="$jenkins_admin_pass"
}
```

**ESO Sync** (happens in `_deploy_jenkins_eso`):
- Creates ExternalSecret resource
- ESO syncs `secret/eso/jenkins-admin` from Vault → `jenkins-admin` K8s secret
- Jenkins reads from K8s secret

**JCasC Security Config** (values.yaml:142-164):
```yaml
01-security: |
  jenkins:
    securityRealm:
      ldap:
        configurations:
          - server: "${LDAP_URL}"
            rootDN: "${LDAP_BASE_DN}"
            # ... LDAP config ...
    authorizationStrategy:
      projectMatrix:
        entries:
          - group:
              name: "jenkins-admins"
              permissions:
                - "Overall/Read"
                - "Overall/Administer"
```

**awk Filtering** (jenkins.sh:1042-1123):
- When `JENKINS_LDAP_ENABLED=0`, awk script removes:
  - LDAP environment variables from `controller.containerEnv`
  - LDAP `securityRealm` block from JCasC `01-security`

**Current Status**: ✅ **WORKING** (as of commit b84ab1c)
- Random password generated: ✅
- ESO syncs to K8s secret: ✅
- LDAP config properly filtered: ✅
- Jenkins uses built-in user database: ✅

**PASSWORD RETRIEVAL**:
```bash
kubectl exec -n jenkins svc/jenkins -c jenkins -- \
  cat /run/secrets/additional/chart-admin-password
```

---

### Scenario 3: `deploy_jenkins --enable-vault --enable-ldap`

**Command**: `./scripts/k3d-manager deploy_jenkins --enable-vault --enable-ldap`

**Expected Behavior**:
- Jenkins with Vault-issued TLS certificates
- LDAP authentication for users
- LDAP groups mapped to Jenkins authorization strategy
- Local admin account as fallback (?)

**Current Implementation**:

**LDAP Deployment** (jenkins.sh:877-880):
```bash
if (( enable_ldap )); then
   _deploy_jenkins_ldap "$vault_namespace" "$vault_release"
else
   _info "[jenkins] skipping LDAP deployment"
fi
```

**awk Filtering Logic** (jenkins.sh:1042-1123):
```bash
if (( ! JENKINS_LDAP_ENABLED )); then
   # Filter YAML to remove LDAP env vars and JCasC config
   awk '...' "$values_file" > "$temp_values"
   values_file="$temp_values"
fi
```

**CRITICAL QUESTION**: When `JENKINS_LDAP_ENABLED=1`, what happens?

**Answer**: Filtering is **SKIPPED** - original values.yaml is used as-is:
- ✅ LDAP environment variables are INCLUDED
- ✅ JCasC LDAP securityRealm is INCLUDED
- ✅ LDAP authentication should work

**Values Used** (values.yaml:53-73, 142-164):
```yaml
# LDAP environment variables - PRESENT when --enable-ldap
- name: LDAP_URL
  value: "ldap://openldap.directory.svc.cluster.local:389"
- name: LDAP_GROUP_SEARCH_BASE
  value: "ou=groups"
- name: LDAP_USER_SEARCH_BASE
  value: "ou=service"
- name: LDAP_BASE_DN
  valueFrom:
    secretKeyRef:
      name: jenkins-ldap-config
      key: LDAP_BASE_DN
# ... more env vars ...

# JCasC security config - PRESENT when --enable-ldap
01-security: |
  jenkins:
    securityRealm:
      ldap:
        configurations:
          - server: "${LDAP_URL}"
            rootDN: "${LDAP_BASE_DN}"
            groupSearchBase: "${LDAP_GROUP_SEARCH_BASE}"
            userSearchBase: "${LDAP_USER_SEARCH_BASE}"
            managerDN: "${LDAP_BIND_DN}"
            managerPasswordSecret: "${LDAP_BIND_PASSWORD}"
            inhibitInferRootDN: false
            displayNameAttributeName: "cn"
            mailAddressAttributeName: "mail"
        disableMailAddressResolver: false
    authorizationStrategy:
      projectMatrix:
        entries:
          - group:
              name: "jenkins-admins"
              permissions:
                - "Overall/Read"
                - "Overall/Administer"
```

**Current Status**: ⚠️ **LIKELY WORKING** (needs verification)
- LDAP env vars present: ✅ (awk filtering skipped)
- JCasC LDAP config present: ✅ (awk filtering skipped)
- LDAP credentials synced via ESO: ✅ (jenkins-ldap-config secret)
- Authorization strategy uses LDAP groups: ✅

**OPEN QUESTION**: Can local admin (jenkins-admin) still login when LDAP is enabled?
- Jenkins LDAP plugin typically allows fallback to built-in database
- Needs manual testing to confirm

---

## Implementation Gaps

### Gap #1: Deployment without Vault is broken

**Issue**: Policy creation functions always run even when Vault disabled

**Location**: jenkins.sh:882-884
```bash
_create_jenkins_admin_vault_policy "$vault_namespace" "$vault_release"
_create_jenkins_vault_ad_policy "$vault_namespace" "$vault_release" "$jenkins_namespace"
_create_jenkins_cert_rotator_policy "$vault_namespace" "$vault_release" "" "" "$jenkins_namespace"
```

**Fix Required**:
```bash
if (( enable_vault )); then
   _create_jenkins_admin_vault_policy "$vault_namespace" "$vault_release"
   _create_jenkins_vault_ad_policy "$vault_namespace" "$vault_release" "$jenkins_namespace"
   _create_jenkins_cert_rotator_policy "$vault_namespace" "$vault_release" "" "" "$jenkins_namespace"
fi
```

---

### Gap #2: No admin credentials without Vault

**Issue**: Jenkins Helm chart expects `jenkins-admin` secret to exist, but without Vault/ESO, nothing creates it

**Location**: values.yaml:88-92

**Options**:

**Option A**: Require Vault for all deployments (simplest)
- Document that `deploy_jenkins` without flags is unsupported
- Require `--enable-vault` as minimum
- Update help text

**Option B**: Create static admin credentials when Vault disabled
```bash
if (( ! enable_vault )); then
   # Create static admin secret
   kubectl create secret generic jenkins-admin \
     -n "$jenkins_namespace" \
     --from-literal=jenkins-admin-user=admin \
     --from-literal=jenkins-admin-password=changeme \
     --dry-run=client -o yaml | kubectl apply -f -

   _warn "[jenkins] Using static admin credentials (username: admin, password: changeme)"
   _warn "[jenkins] CHANGE PASSWORD IMMEDIATELY after first login!"
fi
```

**Option C**: Use Helm's built-in secret creation
```bash
if (( ! enable_vault )); then
   # Modify values.yaml to use Helm secret creation
   yq eval '.controller.admin.createSecret = true |
            .controller.admin.existingSecret = null |
            .controller.admin.username = "admin" |
            .controller.admin.password = "changeme"' \
      "$values_file" > "$temp_values"
fi
```

---

### Gap #3: LDAP-only deployment is impossible

**Issue**: `deploy_jenkins --enable-ldap` (without Vault) will fail

**Root Cause**:
- LDAP credentials stored in Vault (scripts/plugins/ldap.sh)
- ESO requires Vault as backend
- No alternative credential storage mechanism

**Options**:

**Option A**: Require Vault for LDAP (current architecture)
- Document that LDAP requires `--enable-vault --enable-ldap`
- Add validation to reject `--enable-ldap` without `--enable-vault`

**Option B**: Support standalone LDAP with K8s secrets
- Significant refactoring required
- Need to create `jenkins-ldap-config` secret directly
- Skip ESO/Vault integration
- Out of scope for current work

---

## Recommended Implementation Plan

### Phase 1: Fix Critical Bugs (Immediate)

**Task 1.1**: Make Vault policy creation conditional
```bash
# jenkins.sh:882-884
if (( enable_vault )); then
   _create_jenkins_admin_vault_policy "$vault_namespace" "$vault_release"
   _create_jenkins_vault_ad_policy "$vault_namespace" "$vault_release" "$jenkins_namespace"
   _create_jenkins_cert_rotator_policy "$vault_namespace" "$vault_release" "" "" "$jenkins_namespace"
fi
```

**Task 1.2**: Add LDAP validation
```bash
# jenkins.sh: After argument parsing (around line 850)
if (( enable_ldap && ! enable_vault )); then
   _err "[jenkins] --enable-ldap requires --enable-vault (LDAP credentials stored in Vault)"
fi
```

**Task 1.3**: Handle deployment without Vault
- **Option A** (Recommended): Document as unsupported, require `--enable-vault`
- **Option B**: Create static admin credentials (security risk)
- **Option C**: Use Helm's secret creation (requires values.yaml modification)

### Phase 2: Documentation (Immediate)

**Task 2.1**: Update help text (jenkins.sh:751-773)
```bash
Supported deployment modes:
  1. Vault-only:     deploy_jenkins --enable-vault
  2. Vault + LDAP:   deploy_jenkins --enable-vault --enable-ldap

Note: LDAP integration requires Vault (credentials stored in Vault/ESO).
      Deployment without --enable-vault is not currently supported.
```

**Task 2.2**: Add password retrieval instructions
```bash
Retrieve admin password (Vault-only mode):
  kubectl exec -n jenkins svc/jenkins -c jenkins -- \\
    cat /run/secrets/additional/chart-admin-password
```

### Phase 3: Testing (Next)

**Task 3.1**: Manual deployment test with `--enable-vault --enable-ldap`
- Verify LDAP securityRealm present in JCasC
- Verify LDAP authentication works
- Verify local admin can still login (fallback)

**Task 3.2**: Update test cases
- Test policy creation conditionals
- Test LDAP validation
- Test password retrieval

---

## Testing Checklist

- [ ] `deploy_jenkins` (no flags) - should fail gracefully or create static credentials
- [ ] `deploy_jenkins --enable-vault` - ✅ VERIFIED WORKING (b84ab1c)
- [ ] `deploy_jenkins --enable-ldap` - should fail with error message
- [ ] `deploy_jenkins --enable-vault --enable-ldap` - needs manual verification
- [ ] Password retrieval via kubectl exec
- [ ] LDAP user authentication
- [ ] Local admin fallback when LDAP enabled

---

## Questions for User

1. **Deployment without Vault**: Should we support it? If yes, how should admin credentials be created?
   - Static password (security risk, simple)
   - Helm-generated secret (requires values modification)
   - Reject deployment (document as unsupported)

2. **LDAP fallback**: Should local admin (jenkins-admin) remain accessible when LDAP is enabled?
   - Current implementation: admin secret exists, likely works as fallback
   - Need to verify Jenkins LDAP plugin behavior

3. **Password visibility**: Should we log the admin password retrieval command after deployment?
   - Helpful for operators
   - Already documented in Helm notes

---

## Related Files

- `scripts/plugins/jenkins.sh` - Main deployment logic
- `scripts/plugins/vault.sh` - Password policy creation (line 1311)
- `scripts/etc/jenkins/values.yaml` - Helm values with admin config (88-92) and JCasC (142-164)
- `scripts/tests/plugins/jenkins.bats` - Test suite (needs updates)
