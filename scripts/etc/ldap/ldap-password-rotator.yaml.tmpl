---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ldap-password-rotator
  namespace: ${LDAP_NAMESPACE}
data:
  rotate.sh: |
    #!/bin/sh
    # LDAP Password Rotation Script
    # Rotates passwords for LDAP users and updates Vault

    set -eu

    # Configuration from environment variables
    LDAP_NAMESPACE="${LDAP_NAMESPACE:-directory}"
    LDAP_POD_LABEL="${LDAP_POD_LABEL:-app.kubernetes.io/name=openldap}"
    LDAP_PORT="${LDAP_PORT:-389}"
    LDAP_BASE_DN="${LDAP_BASE_DN:-dc=home,dc=org}"
    LDAP_ADMIN_DN="${LDAP_ADMIN_DN:-cn=ldap-admin,dc=home,dc=org}"
    LDAP_USER_OU="${LDAP_USER_OU:-ou=users}"
    VAULT_NAMESPACE="${VAULT_NAMESPACE:-vault}"
    VAULT_ADDR="${VAULT_ADDR:-http://vault.vault.svc:8200}"
    VAULT_ROOT_TOKEN_SECRET="${VAULT_ROOT_TOKEN_SECRET:-vault-root}"
    VAULT_ROOT_TOKEN_KEY="${VAULT_ROOT_TOKEN_KEY:-root_token}"

    # Users to rotate (comma-separated)
    USERS_TO_ROTATE="${USERS_TO_ROTATE:-chengkai.liang,jenkins-admin,test-user}"

    log() {
        echo "[$(date +'%Y-%m-%d %H:%M:%S')] $*"
    }

    error() {
        echo "[$(date +'%Y-%m-%d %H:%M:%S')] ERROR: $*" >&2
    }

    # Hash password for display (SHA256)
    hash_password() {
        printf "%s" "$1" | sha256sum | cut -d' ' -f1
    }

    # Get LDAP pod name
    get_ldap_pod() {
        local pod_name
        pod_name=$(kubectl get pod -n "$LDAP_NAMESPACE" -l "$LDAP_POD_LABEL" \
            -o jsonpath='{.items[0].metadata.name}' 2>&1)
        if [ -z "$pod_name" ] || echo "$pod_name" | grep -q "Error"; then
            error "Failed to find LDAP pod with label: $LDAP_POD_LABEL"
            error "kubectl output: $pod_name"
            # Try alternative label
            pod_name=$(kubectl get pod -n "$LDAP_NAMESPACE" -l "app.kubernetes.io/name=openldap-bitnami" \
                -o jsonpath='{.items[0].metadata.name}' 2>&1)
            if [ -z "$pod_name" ] || echo "$pod_name" | grep -q "Error"; then
                error "Failed to find LDAP pod with alternative label"
                return 1
            fi
        fi
        echo "$pod_name"
    }

    # Get LDAP admin password from K8s secret
    get_ldap_admin_password() {
        kubectl get secret -n "$LDAP_NAMESPACE" openldap-admin \
            -o jsonpath='{.data.LDAP_ADMIN_PASSWORD}' 2>/dev/null | base64 -d || {
            error "Failed to get LDAP admin password"
            return 1
        }
    }

    # Get Vault root token
    get_vault_token() {
        kubectl get secret -n "$VAULT_NAMESPACE" "$VAULT_ROOT_TOKEN_SECRET" \
            -o jsonpath="{.data.$VAULT_ROOT_TOKEN_KEY}" 2>/dev/null | base64 -d || {
            error "Failed to get Vault root token"
            return 1
        }
    }

    # Generate random password
    generate_password() {
        openssl rand -base64 18 | tr -d '/+=' | head -c 20
    }

    # Update password in LDAP
    update_ldap_password() {
        local user_dn="$1"
        local new_password="$2"
        local ldap_pod="$3"
        local admin_pass="$4"

        kubectl exec -n "$LDAP_NAMESPACE" "$ldap_pod" -- \
            ldappasswd -x -H "ldap://localhost:${LDAP_PORT}" \
            -D "$LDAP_ADMIN_DN" -w "$admin_pass" \
            -s "$new_password" "$user_dn" >/dev/null 2>&1
    }

    # Update password in Vault
    update_vault_password() {
        local username="$1"
        local new_password="$2"
        local user_dn="$3"
        local vault_token="$4"

        local vault_path="ldap/users/${username}"

        # kubectl exec may show RBAC error about "get pods" permission but exec still works
        kubectl exec -n "$VAULT_NAMESPACE" vault-0 -- \
            env VAULT_TOKEN="$vault_token" VAULT_ADDR="$VAULT_ADDR" \
            vault kv put "secret/$vault_path" \
            username="$username" \
            password="$new_password" \
            dn="$user_dn" \
            rotated_at="$(date -u +%Y-%m-%dT%H:%M:%SZ)" >/dev/null 2>&1
    }

    # Main rotation logic
    main() {
        log "Starting LDAP password rotation"

        # Get required resources
        ldap_pod=$(get_ldap_pod) || exit 1
        log "Found LDAP pod: $ldap_pod"

        admin_pass=$(get_ldap_admin_password) || exit 1
        log "Retrieved LDAP admin password"

        vault_token=$(get_vault_token) || exit 1
        log "Retrieved Vault token"

        # Process comma-separated users using simple while loop
        # We use temp files to track counts since variables in while pipeline run in subshell
        tmp_success="/tmp/success_count.$$"
        tmp_failure="/tmp/failure_count.$$"
        echo "0" > "$tmp_success"
        echo "0" > "$tmp_failure"

        echo "$USERS_TO_ROTATE" | tr ',' '\n' | while IFS= read -r user; do
            # Trim whitespace
            user=$(echo "$user" | xargs 2>/dev/null || echo "$user" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

            # Skip empty usernames
            if [ -z "$user" ]; then
                continue
            fi

            user_dn="cn=${user},${LDAP_USER_OU},${LDAP_BASE_DN}"

            log "Rotating password for: $user"

            # Generate new password
            new_password=$(generate_password)
            password_hash=$(hash_password "$new_password")

            log "  Generated password hash (SHA256): ${password_hash:0:16}..."

            # Update LDAP
            if update_ldap_password "$user_dn" "$new_password" "$ldap_pod" "$admin_pass"; then
                log "  ✓ Updated LDAP password for $user"
            else
                error "  ✗ Failed to update LDAP password for $user"
                echo $(( $(cat "$tmp_failure") + 1 )) > "$tmp_failure"
                continue
            fi

            # Update Vault
            if update_vault_password "$user" "$new_password" "$user_dn" "$vault_token"; then
                log "  ✓ Updated Vault password for $user (hash: ${password_hash:0:16}...)"
                echo $(( $(cat "$tmp_success") + 1 )) > "$tmp_success"
            else
                error "  ✗ Failed to update Vault password for $user"
                echo $(( $(cat "$tmp_failure") + 1 )) > "$tmp_failure"
            fi
        done

        success_count=$(cat "$tmp_success" 2>/dev/null || echo "0")
        failure_count=$(cat "$tmp_failure" 2>/dev/null || echo "0")
        rm -f "$tmp_success" "$tmp_failure"

        log "Password rotation complete: $success_count succeeded, $failure_count failed"

        if [ "$failure_count" -gt 0 ]; then
            exit 1
        fi
    }

    main "$@"

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: ldap-password-rotator
  namespace: ${LDAP_NAMESPACE}

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: ldap-password-rotator
  namespace: ${LDAP_NAMESPACE}
rules:
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list"]
  - apiGroups: [""]
    resources: ["pods/exec"]
    verbs: ["create"]
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: ldap-password-rotator-vault
  namespace: ${VAULT_NAMESPACE}
rules:
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get"]
  - apiGroups: [""]
    resources: ["pods/exec"]
    verbs: ["create"]
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: ldap-password-rotator
  namespace: ${LDAP_NAMESPACE}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: ldap-password-rotator
subjects:
  - kind: ServiceAccount
    name: ldap-password-rotator
    namespace: ${LDAP_NAMESPACE}

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: ldap-password-rotator-vault
  namespace: ${VAULT_NAMESPACE}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: ldap-password-rotator-vault
subjects:
  - kind: ServiceAccount
    name: ldap-password-rotator
    namespace: ${LDAP_NAMESPACE}

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: ldap-password-rotator
  namespace: ${LDAP_NAMESPACE}
spec:
  schedule: "${LDAP_PASSWORD_ROTATION_SCHEDULE}"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: ldap-password-rotator
        spec:
          serviceAccountName: ldap-password-rotator
          restartPolicy: OnFailure
          containers:
            - name: rotator
              image: ${LDAP_PASSWORD_ROTATOR_IMAGE}
              command: ["sh"]
              args: ["/scripts/rotate.sh"]
              env:
                - name: LDAP_NAMESPACE
                  value: "${LDAP_NAMESPACE}"
                - name: LDAP_POD_LABEL
                  value: "${LDAP_POD_LABEL}"
                - name: LDAP_PORT
                  value: "${LDAP_PORT}"
                - name: LDAP_BASE_DN
                  value: "${LDAP_BASE_DN}"
                - name: LDAP_ADMIN_DN
                  value: "${LDAP_ADMIN_DN}"
                - name: LDAP_USER_OU
                  value: "${LDAP_USER_OU}"
                - name: VAULT_NAMESPACE
                  value: "${VAULT_NAMESPACE}"
                - name: VAULT_ADDR
                  value: "${VAULT_ADDR}"
                - name: VAULT_ROOT_TOKEN_SECRET
                  value: "${VAULT_ROOT_TOKEN_SECRET}"
                - name: VAULT_ROOT_TOKEN_KEY
                  value: "${VAULT_ROOT_TOKEN_KEY}"
                - name: USERS_TO_ROTATE
                  value: "${USERS_TO_ROTATE}"
              volumeMounts:
                - name: scripts
                  mountPath: /scripts
                  readOnly: true
          volumes:
            - name: scripts
              configMap:
                name: ldap-password-rotator
                defaultMode: 0755
