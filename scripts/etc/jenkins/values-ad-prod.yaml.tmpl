controller:
  sidecars:
    configAutoReload:
      enabled: true
  podAnnotations:
    sidecar.istio.io/inject: "false"
    vault.hashicorp.com/agent-inject: "true"
    vault.hashicorp.com/role: "jenkins-ad-reader"
    vault.hashicorp.com/agent-pre-populate-only: "true"
    vault.hashicorp.com/agent-inject-secret-ad-bind-user: "${AD_VAULT_PATH}"
    vault.hashicorp.com/agent-inject-template-ad-bind-user: |-
      {{ "{{" }}- with secret "${AD_VAULT_PATH}" -{{ "}}" }}
      {{ "{{" }}- .Data.data.${AD_USERNAME_KEY} -{{ "}}" }}
      {{ "{{" }}- end -{{ "}}" }}
    vault.hashicorp.com/agent-inject-secret-ad-bind-password: "${AD_VAULT_PATH}"
    vault.hashicorp.com/agent-inject-template-ad-bind-password: |-
      {{ "{{" }}- with secret "${AD_VAULT_PATH}" -{{ "}}" }}
      {{ "{{" }}- .Data.data.${AD_PASSWORD_KEY} -{{ "}}" }}
      {{ "{{" }}- end -{{ "}}" }}
  image:
    registry: docker.io
    repository: jenkins/jenkins
    tag: lts
    pullPolicy: IfNotPresent
  installPlugins:
    - active-directory
    - configuration-as-code
    - credentials
    - git
    - hashicorp-vault-plugin
    - job-dsl
    - kubernetes
    - matrix-auth
    - matrix-project
    - metrics
    - mina-sshd-api-common
    - mina-sshd-api-core
    - okhttp-api
    - parameterized-trigger
    - workflow-aggregator
    - workflow-multibranch
    - pipeline-build-step
    - pipeline-stage-view
    - pipeline-utility-steps
    - plain-credentials
    - plugin-util-api
    - script-security
    - ssh-credentials
    - ssh-slaves
    - sshd
    ${JENKINS_MFA_PLUGIN}
  # Use Helm chart's built-in javaOpts and jenkinsOpts instead of containerEnv
  javaOpts: "-Djenkins.install.runSetupWizard=false"
  jenkinsOpts: "--httpPort=8080 --httpListenAddress=0.0.0.0"

  containerEnv:
    - name: JENKINS_ADMIN_USER
      value: "jenkins-admin"
    - name: JENKINS_ADMIN_PASS
      valueFrom:
        secretKeyRef:
          name: jenkins-admin
          key: jenkins-admin-password
    - name: AD_DOMAIN
      value: "${AD_DOMAIN}"
    - name: AD_SERVER
      value: "${AD_SERVER}"
    - name: AD_SITE
      value: "${AD_SITE}"

  serviceAccount:
    create: true
    name: jenkins-admin

  admin:
    createSecret: false
    existingSecret: jenkins-admin
    userKey: jenkins-admin-user
    passwordKey: jenkins-admin-password

  podSecurityContext:
    fsGroup: 1000

      03-job-dsl-seed: |
        jobs:
          - script: >
              freeStyleProject('seed-job') {
                displayName('Job DSL Seed Job')
                description('Master seed job that processes all Job DSL scripts from ConfigMap to create Jenkins jobs automatically')

                steps {
                  dsl {
                    external('seed-job.groovy')
                    removeAction('DISABLE')
                    removeViewAction('IGNORE')
                    lookupStrategy('SEED_JOB')
                    additionalClasspath('/var/jenkins_config/job-dsl')
                  }
                }

                triggers {
                  cron('@daily')
                }

                logRotator {
                  numToKeep(10)
                  daysToKeep(30)
                }
              }

  # Volume mounts for Job DSL scripts from ConfigMap
  additionalExistingSecrets:
    - name: job-dsl-scripts
      keyName: dummy

  # Mount Job DSL ConfigMap
  customInitContainers:
    - name: copy-job-dsl-scripts
      image: busybox:latest
      command:
        - sh
        - -c
        - |
          cp /tmp/job-dsl/* /var/jenkins_config/job-dsl/ 2>/dev/null || true
          cp /tmp/job-dsl/* /var/jenkins_config/job-dsl/ 2>/dev/null || true
          ls -la /var/jenkins_config/job-dsl/
      volumeMounts:
        - name: job-dsl-scripts-volume
          mountPath: /tmp/job-dsl
        - name: jenkins-home
          mountPath: /var/jenkins_config

  # Add volume for Job DSL ConfigMap
  additionalVolumes:
    - name: job-dsl-scripts-volume
      configMap:
        name: jenkins-job-dsl


# Optional but keeps env consistent with JCasC Location
    runAsUser: 1000

  persistence:
    enabled: true
    existingClaim: jenkins-home

  serviceType: ClusterIP
  servicePort: 8081
  targetPort: 8080
  containerPort: 8080
  servicePortName: http

  healthProbes: true
  probes:
    startupProbe:
      httpGet:
        path: /login
        port: 8080
        scheme: HTTP
      initialDelaySeconds: 90
      periodSeconds: 5
      failureThreshold: 180
    readinessProbe:
      httpGet:
        path: /login
        port: 8080
        scheme: HTTP
      initialDelaySeconds: 90
      periodSeconds: 5
      failureThreshold: 120
    livenessProbe:
      httpGet:
        path: /login
        port: 8080
        scheme: HTTP
      initialDelaySeconds: 90
      periodSeconds: 5
      failureThreshold: 60
  JCasC:
    defaultConfig: false
    configScripts:
      00-location.yaml: |
        unclassified:
          location:
            url: "https://${VAULT_PKI_LEAF_HOST}/"      # trailing slash required
            adminAddress: "jenkins-admin@me.com"
      01-security: |
        jenkins:
          disabledAdministrativeMonitors:
            - "jenkins.security.ReverseProxySetupMonitor"
          securityRealm:
            activeDirectory:
              bindPassword: "$${file:/vault/secrets/ad-bind-password}"
              cache:
                size: ${AD_CACHE_SIZE}
                ttl: ${AD_CACHE_TTL}
              customDomain: ${AD_CUSTOM_DOMAIN}
              domains:
                - bindName: "$${file:/vault/secrets/ad-bind-user}"
                  bindPassword: "$${file:/vault/secrets/ad-bind-password}"
                  name: "${AD_DOMAIN}"
                  servers: "${AD_SERVER}"
                  site: "${AD_SITE}"
                  tlsConfiguration: "${AD_TLS_CONFIG}"
              groupLookupStrategy: "${AD_GROUP_LOOKUP_STRATEGY}"
              internalUsersDatabase:
                jenkinsInternalUser: "jenkins-admin"
              removeIrrelevantGroups: ${AD_REMOVE_IRRELEVANT_GROUPS}
              requireTLS: ${AD_REQUIRE_TLS}
              startTls: ${AD_START_TLS}
          authorizationStrategy:
            projectMatrix:
              entries:
                - group:
                    name: "${AD_ADMIN_GROUP}"
                    permissions:
                      - "Overall/Read"
                      - "Overall/Administer"
      02-kubernetes-agents: |
        jenkins:
          clouds:
            - kubernetes:
                name: "kubernetes"
                serverUrl: "https://kubernetes.default"
                namespace: "${JENKINS_NAMESPACE}"
                jenkinsUrl: "http://jenkins.${JENKINS_NAMESPACE}.svc.cluster.local:8081"
                jenkinsTunnel: "jenkins-agent.${JENKINS_NAMESPACE}.svc.cluster.local:50000"
                containerCapStr: "10"
                maxRequestsPerHostStr: "32"
                retentionTimeout: 5
                connectTimeout: 10
                readTimeout: 20
                templates:
                  - name: "linux-agent"
                    label: "linux-agent"
                    nodeUsageMode: "NORMAL"
                    containers:
                      - name: "jnlp"
                        image: "jenkins/inbound-agent:latest"
                        alwaysPullImage: false
                        workingDir: "/home/jenkins/agent"
                        command: ""
                        args: ""
                        ttyEnabled: true
                        resourceRequestCpu: "500m"
                        resourceRequestMemory: "512Mi"
                        resourceLimitCpu: "1000m"
                        resourceLimitMemory: "1Gi"
                    yaml: |
                      apiVersion: v1
                      kind: Pod
                      metadata:
                        labels:
                          jenkins-agent: "linux"
                        annotations:
                          sidecar.istio.io/inject: "false"
                      spec:
                        serviceAccountName: jenkins-admin
                        securityContext:
                          fsGroup: 1000
                  - name: "kaniko-agent"
                    label: "kaniko-agent"
                    nodeUsageMode: "NORMAL"
                    containers:
                      - name: "jnlp"
                        image: "jenkins/inbound-agent:latest"
                        alwaysPullImage: false
                        workingDir: "/home/jenkins/agent"
                        command: ""
                        args: ""
                        ttyEnabled: true
                        resourceRequestCpu: "500m"
                        resourceRequestMemory: "512Mi"
                        resourceLimitCpu: "1000m"
                        resourceLimitMemory: "1Gi"
                      - name: "kaniko"
                        image: "gcr.io/kaniko-project/executor:debug"
                        alwaysPullImage: false
                        workingDir: "/home/jenkins/agent"
                        command: "/busybox/cat"
                        ttyEnabled: true
                        resourceRequestCpu: "500m"
                        resourceRequestMemory: "1Gi"
                        resourceLimitCpu: "2000m"
                        resourceLimitMemory: "2Gi"
                    volumes:
                      - emptyDirVolume:
                          memory: false
                          mountPath: "/kaniko/.docker"
                    yaml: |
                      apiVersion: v1
                      kind: Pod
                      metadata:
                        labels:
                          jenkins-agent: "kaniko"
                        annotations:
                          sidecar.istio.io/inject: "false"
                      spec:
                        serviceAccountName: jenkins-admin
                        securityContext:
                          fsGroup: 1000

      03-job-dsl-seed: |
        jobs:
          - script: >
              freeStyleProject('seed-job') {
                displayName('Job DSL Seed Job')
                description('Master seed job that processes all Job DSL scripts from ConfigMap to create Jenkins jobs automatically')

                steps {
                  dsl {
                    external('seed-job.groovy')
                    removeAction('DISABLE')
                    removeViewAction('IGNORE')
                    lookupStrategy('SEED_JOB')
                    additionalClasspath('/var/jenkins_config/job-dsl')
                  }
                }

                triggers {
                  cron('@daily')
                }

                logRotator {
                  numToKeep(10)
                  daysToKeep(30)
                }
              }

  # Volume mounts for Job DSL scripts from ConfigMap
  additionalExistingSecrets:
    - name: job-dsl-scripts
      keyName: dummy

  # Mount Job DSL ConfigMap
  customInitContainers:
    - name: copy-job-dsl-scripts
      image: busybox:latest
      command:
        - sh
        - -c
        - |
          cp /tmp/job-dsl/* /var/jenkins_config/job-dsl/ 2>/dev/null || true
          cp /tmp/job-dsl/* /var/jenkins_config/job-dsl/ 2>/dev/null || true
          ls -la /var/jenkins_config/job-dsl/
      volumeMounts:
        - name: job-dsl-scripts-volume
          mountPath: /tmp/job-dsl
        - name: jenkins-home
          mountPath: /var/jenkins_config

  # Add volume for Job DSL ConfigMap
  additionalVolumes:
    - name: job-dsl-scripts-volume
      configMap:
        name: jenkins-job-dsl


# Optional but keeps env consistent with JCasC Location
  jenkinsUrl: "https://${VAULT_PKI_LEAF_HOST}/"
