/*
 *  Run in “Manage Jenkins ▶ Script Console”
 *  or via Jenkins CLI:  groovy = < fixAmbiguity.groovy
 */
import jenkins.model.*
import hudson.security.*

def j   = Jenkins.instance
def acl = j.authorizationStrategy
if (!(acl instanceof GlobalMatrixAuthorizationStrategy)) {
    println "Not using Global Matrix → nothing to fix"
    return
}


int changed = 0
// 1) Ensure admin exists with a password  (security realm)
def realm = Jenkins.instance.getSecurityRealm()
if (realm instanceof HudsonPrivateSecurityRealm) {
    realm.createAccount('admin', System.getenv('ADMIN_PASS') ?: 'changeme')
}

j.setAuthorizationStrategy(acl)


// 2) Persist
j.setAuthorizationStrategy(acl)
j.save()
println "✔ Matrix cleaned. You should now see exactly one 'admin' row with your checked boxes."
