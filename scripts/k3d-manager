#!/usr/bin/env bash

# k3d-manager - K3d Kubernetes cluster setup with Istio and storage configuration
#
# USAGE:
#   ./k3d-manager                    # Show usage and list core functions
#   ./k3d-manager <function> [args]  # Run specific function

# ensure we are running bash
if [[ -n "$BASH_VERSION" ]]; then
   echo "running under bash version ${BASH_VERSION}"
elif [[ -n "$ZSH_VERSION" ]]; then
   echo "running under zsh version ${ZSH_VERSION}"
fi

DEBUG=${DEBUG:-0}
if [[ $DEBUG -gt 0 ]]; then
      set -xv
fi

ENABLE_TRACE=${ENABLE_TRACE:-0}
if [[ $ENABLE_TRACE -gt 0 ]]; then
   export PS4='+ $(date "+%H:%M:%S") - pid=$$ ${BASH_SOURCE##*/}:${LINENO}:${FUNCNAME[0]}() '
   exec 19> /tmp/k3d.trace
   trap 'set +x 2>/dev/null; exec 19>&- 2>/dev/null || true' EXIT
   export BASH_XTRACEFD=19
   set -x
fi

# resolve symlink so that we can figure out where script is actually located
SOURCE="${BASH_SOURCE[0]}"
while [ -L "$SOURCE" ]; do
  DIR="$(cd -P "$(dirname "$SOURCE")" >/dev/null 2>&1 && pwd)"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" >/dev/null 2>&1 && pwd)"
PLUGINS_DIR="${SCRIPT_DIR}/plugins"

# load our library functions
source "${SCRIPT_DIR}/lib/system.sh"
source "${SCRIPT_DIR}/lib/test.sh"
source "${SCRIPT_DIR}/lib/core.sh"

function _usage() {
    local test_suites
    test_suites=$(find "${SCRIPT_DIR}/tests" -type f -name '*.bats' \
        -exec basename {} .bats \; | sort | paste -sd '|' -)

    cat <<EOF
Usage: ./k3d-manager <function> [args]

Available core functions:
$(declare -F | awk '{print $3}' | grep -v '^_' | sort | sed 's/^/  /')

Plugin functions are loaded on demand from scripts/plugins.

Subcommands:
  test all|${test_suites}   Run BATS tests
EOF
}

function test() {
    _ensure_bats
    local suite="$1"
    local search_dirs=("${SCRIPT_DIR}/tests/lib" "${SCRIPT_DIR}/tests/core" "${SCRIPT_DIR}/tests/plugins")
    local tests
    mapfile -t tests < <(find "${search_dirs[@]}" -maxdepth 1 -type f -name '*.bats' | sort)

    if [[ "$suite" == "all" ]]; then
        bats "${tests[@]}"
        return
    fi

    for test_file in "${tests[@]}"; do
        if [[ "$(basename "$test_file" .bats)" == "$suite" ]]; then
            bats "$test_file"
            return
        fi
    done

    echo "No test suite matching '$suite'. Available suites:" >&2
    printf '  %s\n' "${tests[@]##*/}" | sed 's/\.bats$//' >&2
    return 1
}

## -- main --
if [[ $# -eq 0 ]]; then
    _usage
    exit 0
fi

function_name=$1
shift  # Remove the function name from the arguments

if [[ "$(type -t "$function_name")" == "function" ]]; then
    # Call the function with remaining arguments
    $function_name "$@"
else
    _try_load_plugin "$function_name" "$@"
fi
