#!/usr/bin/env bash

# k3d-manager - K3d Kubernetes cluster setup with Istio and storage configuration
#
# USAGE:
#   ./k3d-manager                    # Show usage and list core functions
#   ./k3d-manager <function> [args]  # Run specific function

# ensure we are running bash
if [[ -n "$BASH_VERSION" ]]; then
   echo "running under bash version ${BASH_VERSION}"
elif [[ -n "$ZSH_VERSION" ]]; then
   echo "running under zsh version ${ZSH_VERSION}"
fi

DEBUG=${DEBUG:-0}
if [[ $DEBUG -gt 0 ]]; then
      set -xv
fi

ENABLE_TRACE=${ENABLE_TRACE:-0}
if [[ $ENABLE_TRACE -gt 0 ]]; then
   export PS4='+ $(date "+%H:%M:%S") - pid=$$ ${BASH_SOURCE##*/}:${LINENO}:${FUNCNAME[0]}() '
   exec 19> /tmp/k3d.trace
   trap 'set +x 2>/dev/null; exec 19>&- 2>/dev/null || true' EXIT
   export BASH_XTRACEFD=19
   set -x
fi

# resolve symlink so that we can figure out where script is actually located
SOURCE="${BASH_SOURCE[0]}"
while [ -L "$SOURCE" ]; do
  DIR="$(cd -P "$(dirname "$SOURCE")" >/dev/null 2>&1 && pwd)"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" >/dev/null 2>&1 && pwd)"
PLUGINS_DIR="${SCRIPT_DIR}/plugins"

# load our library functions
source "${SCRIPT_DIR}/lib/system.sh"
source "${SCRIPT_DIR}/lib/cluster_provider.sh"
source "${SCRIPT_DIR}/lib/test.sh"
source "${SCRIPT_DIR}/lib/core.sh"
source "${SCRIPT_DIR}/lib/help/utils.sh"

if [[ -n "${CLUSTER_PROVIDER:-}" ]]; then
    export K3D_MANAGER_PROVIDER="${K3D_MANAGER_PROVIDER:-$CLUSTER_PROVIDER}"
    export K3D_MANAGER_CLUSTER_PROVIDER="${K3D_MANAGER_CLUSTER_PROVIDER:-$CLUSTER_PROVIDER}"
    if declare -f _cluster_provider_set_active >/dev/null 2>&1; then
        _cluster_provider_set_active "$(printf '%s' "$CLUSTER_PROVIDER" | tr '[:upper:]' '[:lower:]')"
    fi
elif [[ -n "${K3D_MANAGER_PROVIDER:-}" ]]; then
    export CLUSTER_PROVIDER="$K3D_MANAGER_PROVIDER"
    export K3D_MANAGER_CLUSTER_PROVIDER="${K3D_MANAGER_CLUSTER_PROVIDER:-$K3D_MANAGER_PROVIDER}"
    if declare -f _cluster_provider_set_active >/dev/null 2>&1; then
        _cluster_provider_set_active "$(printf '%s' "$K3D_MANAGER_PROVIDER" | tr '[:upper:]' '[:lower:]')"
    fi
fi

## -- main --
if [[ $# -eq 0 ]]; then
    _usage
    exit 0
fi

function_name=$1
shift  # Remove the function name from the arguments

if [[ "$(type -t "$function_name")" == "function" ]]; then
    # Call the function with remaining arguments
    $function_name "$@"
else
    _try_load_plugin "$function_name" "$@"
fi
